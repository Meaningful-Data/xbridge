Validation API
**************

The ``xbridge.validation`` module provides a standalone validation API for checking XBRL instance files against structural and regulatory rules.

.. currentmodule:: xbridge.validation

Overview
========

The validation module can check both **XBRL-XML** (``.xbrl``) and **XBRL-CSV** (``.zip``) files. It runs a configurable set of validation rules and returns a list of findings, each with a severity level, location, and descriptive message.

Key features:

* **Format-aware**: Automatically detects whether the input is XML or CSV and applies the appropriate rules
* **EBA rules**: Optionally enables EBA-specific regulatory rules (entity, currency, decimals, etc.)
* **Post-conversion mode**: For CSV files generated by xbridge, skips structural checks guaranteed by the converter
* **Extensible registry**: Rules are declared in a JSON registry and can be customised without changing code

Quick Start
===========

.. code-block:: python

    from xbridge.validation import validate

    # Validate an XBRL-XML file
    results = validate("path/to/instance.xbrl")

    if not results:
        print("No issues found.")
    else:
        for finding in results:
            print(f"[{finding.severity.value}] {finding.rule_id}: {finding.message}")

Public API
==========

validate()
----------

.. autofunction:: validate

Usage Examples
==============

Basic Validation
----------------

Check an XBRL-XML instance for structural issues:

.. code-block:: python

    from xbridge.validation import validate

    results = validate("data/instance.xbrl")

    for r in results:
        print(f"[{r.severity.value}] {r.rule_id}: {r.message}")
        print(f"  Location: {r.location}")

Enable EBA Rules
----------------

Run additional EBA-specific checks (entity format, decimal precision, currency, etc.):

.. code-block:: python

    from xbridge.validation import validate

    results = validate("data/instance.xbrl", eba=True)

    errors = [r for r in results if r.severity.value == "ERROR"]
    warnings = [r for r in results if r.severity.value == "WARNING"]

    print(f"Errors: {len(errors)}, Warnings: {len(warnings)}")

Validate a CSV Package
----------------------

Validate an XBRL-CSV ZIP package:

.. code-block:: python

    from xbridge.validation import validate

    results = validate("data/report.zip", eba=True)

Post-Conversion Validation
--------------------------

When validating CSV output produced by xbridge's own converter, use ``post_conversion=True`` to skip structural checks that the converter guarantees:

.. code-block:: python

    from xbridge.validation import validate

    # Only run semantic/EBA checks, skip structural CSV checks
    results = validate("data/converted_output.zip", eba=True, post_conversion=True)

Inspect Findings
----------------

Each finding is a ``ValidationResult`` with detailed information:

.. code-block:: python

    from xbridge.validation import validate, Severity

    results = validate("data/instance.xbrl", eba=True)

    for r in results:
        print(f"Rule:     {r.rule_id}")
        print(f"Severity: {r.severity.value}")
        print(f"Message:  {r.message}")
        print(f"Location: {r.location}")
        print(f"Context:  {r.context}")
        print()

    # Filter by severity
    errors_only = [r for r in results if r.severity == Severity.ERROR]

Parameters
==========

:param file: Path to the XBRL instance file. Accepts ``str`` or ``pathlib.Path``. Supported extensions: ``.xbrl``, ``.xml`` (XML format), ``.zip`` (CSV format).

:param eba: When ``True``, additionally runs EBA-specific validation rules (entity format, decimal precision, currency checks, etc.). Default is ``False``.

:param post_conversion: When ``True`` and validating a CSV (``.zip``) file, skips structural and format checks that are guaranteed by xbridge's converter. Only EBA semantic checks are retained. Has no effect for ``.xbrl`` files. Default is ``False``.

:return: A list of ``ValidationResult`` findings, ordered by rule execution sequence. An empty list means no issues were found.

:raises FileNotFoundError: If the file does not exist.
:raises ValueError: If the file extension is not supported.

Data Classes
============

ValidationResult
----------------

Each finding returned by ``validate()`` is a ``ValidationResult`` instance with the following attributes:

- ``rule_id`` (``str``): The unique rule code (e.g. ``"XML-001"``, ``"EBA-ENTITY-001"``)
- ``severity`` (``Severity``): The severity level of the finding
- ``rule_set`` (``str``): ``"xml"`` or ``"csv"``, indicating the input format
- ``message`` (``str``): Human-readable description of the issue
- ``location`` (``str``): File path, XPath, or row:column locator pointing to the problem
- ``context`` (``dict`` or ``None``): Optional key-value data with diagnostic details

Severity
--------

The ``Severity`` enum has three levels:

- ``Severity.ERROR``: The file violates a mandatory requirement
- ``Severity.WARNING``: The file has a potential issue that may cause problems
- ``Severity.INFO``: Informational observation

.. code-block:: python

    from xbridge.validation import Severity

    # Compare severity levels
    if finding.severity == Severity.ERROR:
        print("This must be fixed.")

Integration with Conversion
===========================

You can validate before converting to catch issues early:

.. code-block:: python

    from xbridge.validation import validate, Severity
    from xbridge.api import convert_instance

    # Validate first
    results = validate("data/instance.xbrl", eba=True)
    errors = [r for r in results if r.severity == Severity.ERROR]

    if errors:
        print("Validation errors found â€” skipping conversion:")
        for e in errors:
            print(f"  [{e.rule_id}] {e.message}")
    else:
        convert_instance(
            instance_path="data/instance.xbrl",
            output_path="data/output"
        )
        print("Conversion complete.")
